%define name thailatex
%define version @VERSION@
%define release 1
%define manifest %{_builddir}/%{name}-%{version}-%{release}.manifest

Summary: Thai extension for LaTeX
Name: %{name}
Version: %{version}
Release: %{release}
Copyright: freely distributable
Group: Applications/Publishing
Source: %{name}-%{version}.tar.gz
BuildArch: noarch
BuildRoot: /var/tmp/%{name}-%{version}
Vendor: Surapant Meknavin <surapan@nectec.or.th>, Theppitak Karoonboonyanan <thep@links.nectec.or.th>, NECTEC
Packager: Theppitak Karoonboonyanan <thep@links.nectec.or.th>
Distribution: Linux TLE, Thai Linux Working Group
Requires: tetex >= 0.9

%description

Thai fonts, style, etc. for publishing Thai documents with LaTeX.
Thai word segmentation filter which inserts "\wbr " command as Thai word
delimitor, such as "swath", is recommended to be used as a preprocessor.

%prep
%setup

%build
./configure --prefix=/usr
make

%install
mkdir -p $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT

# __os_install_post is implicitly expanded after the
# %install section... do it now, and then disable it,
# so all work is done before building manifest.

%{?__os_install_post}
%define __os_install_post %{nil}

# build the file list automagically into %{manifest}

cd $RPM_BUILD_ROOT
rm -f %{manifest}
find . -type d \
        | sed '1,2d;s,^\.,\%attr(-\,root\,root) \%dir ,' >> %{manifest}
find . -type f \
        | sed '/config.ps/d;/pdftex.cfg/d;/site-start.el/d' \
        | sed 's,^\.,\%attr(-\,root\,root) ,' >> %{manifest}
find . -type l \
        | sed 's,^\.,\%attr(-\,root\,root) ,' >> %{manifest}


%post
# add thai.map as additional map to dvips local config
DVIPSCONFIG=$RPM_BUILD_ROOT/usr/share/texmf/dvips/config/config.ps
mkdir -p `dirname $DVIPSCONFIG`
if test -f $DVIPSCONFIG; then
  sed -e '/thailatex/d;/thai.map/d' $DVIPSCONFIG > /tmp/tmp.$$
  mv -f /tmp/tmp.$$ $DVIPSCONFIG
fi
echo "% thailatex" >> $DVIPSCONFIG
echo "p +thai.map" >> $DVIPSCONFIG

# add thai.map as additional map to pdftex local config
PDFTEXCONFIG=$RPM_BUILD_ROOT/usr/share/texmf/pdftex/config/pdftex.cfg
mkdir -p `dirname $PDFTEXCONFIG`
if test -f $PDFTEXCONFIG; then
  sed -e '/thailatex/d;/thai.map/d' $PDFTEXCONFIG > /tmp/tmp.$$
  mv -f /tmp/tmp.$$ $PDFTEXCONFIG
fi
echo "% thailatex"   >> $PDFTEXCONFIG
echo "map +thai.map" >> $PDFTEXCONFIG
 
/usr/bin/texhash

# add Emacs macro for activating Thai LaTeX filter
EMACSLISPDIR=$RPM_BUILD_ROOT/usr/share/emacs/site-lisp
if [ -f $EMACSLISPDIR/site-start.el ] ; then
  sed -e '/thai-latex-setup/d' $EMACSLISPDIR/site-start.el > /tmp/tmp.$$
  mv /tmp/tmp.$$ $EMACSLISPDIR/site-start.el
fi
echo '(load-library "thai-latex-setup")' >> $EMACSLISPDIR/site-start.el


%triggerpostun -- thailatex
# add thai.map as additional map to dvips local config
DVIPSCONFIG=$RPM_BUILD_ROOT/usr/share/texmf/dvips/config/config.ps
mkdir -p `dirname $DVIPSCONFIG`
if test -f $DVIPSCONFIG; then
  sed -e '/thailatex/d;/thai.map/d' $DVIPSCONFIG > /tmp/tmp.$$
  mv -f /tmp/tmp.$$ $DVIPSCONFIG
fi
echo "% thailatex" >> $DVIPSCONFIG
echo "p +thai.map" >> $DVIPSCONFIG

# add thai.map as additional map to pdftex local config
PDFTEXCONFIG=$RPM_BUILD_ROOT/usr/share/texmf/pdftex/config/pdftex.cfg
mkdir -p `dirname $PDFTEXCONFIG`
if test -f $PDFTEXCONFIG; then
  sed -e '/thailatex/d;/thai.map/d' $PDFTEXCONFIG > /tmp/tmp.$$
  mv -f /tmp/tmp.$$ $PDFTEXCONFIG
fi
echo "% thailatex"   >> $PDFTEXCONFIG
echo "map +thai.map" >> $PDFTEXCONFIG
 
/usr/bin/texhash

# add Emacs macro for activating Thai LaTeX filter
EMACSLISPDIR=$RPM_BUILD_ROOT/usr/share/emacs/site-lisp
if [ -f $EMACSLISPDIR/site-start.el ] ; then
  sed -e '/thai-latex-setup/d' $EMACSLISPDIR/site-start.el > /tmp/tmp.$$
  mv /tmp/tmp.$$ $EMACSLISPDIR/site-start.el
fi
echo '(load-library "thai-latex-setup")' >> $EMACSLISPDIR/site-start.el


%preun
# remove thai.map from dvips local config
DVIPSCONFIG=$RPM_BUILD_ROOT/usr/share/texmf/dvips/config/config.ps
if test -f $DVIPSCONFIG; then
  sed -e '/thailatex/d;/thai.map/d' $DVIPSCONFIG > /tmp/tmp.$$
  mv -f /tmp/tmp.$$ $DVIPSCONFIG
fi

# remove thai.map from pdftex local config
PDFTEXCONFIG=$RPM_BUILD_ROOT/usr/share/texmf/pdftex/config/pdftex.cfg
if test -f $PDFTEXCONFIG; then
  sed -e '/thailatex/d;/thai.map/d' $PDFTEXCONFIG > /tmp/tmp.$$
  mv -f /tmp/tmp.$$ $PDFTEXCONFIG
fi

/usr/bin/texhash

# remove Emacs macro for activating Thai LaTeX filter
EMACSLISPDIR=$RPM_BUILD_ROOT/usr/share/emacs/site-lisp
if [ -f $EMACSLISPDIR/site-start.el ] ; then
  sed -e  '/thai-latex-setup/d' $EMACSLISPDIR/site-start.el > /tmp/tmp.$$
  mv /tmp/tmp.$$ $EMACSLISPDIR/site-start.el
fi

%files -f %{manifest}
%defattr(-,root,root)
#%doc README
#%docdir
#%config

%changelog
* Tue Jan 08 2002 Theppitak Karoonboonyanan <thep@links.nectec.or.th>
  - update %post and %postun scripts according to new installing method
  - fix upgrading bug by adding %triggerpostun script to do the %post
    job again, after the %postun script of the older version removed
    every patch. (%post is still needed for rpm -i case.. Hmm.. messy)
  - change %postun to %preun, to be safe about the order of %postun
    of the older package and %triggerpostun of the newer package.

* Wed Dec 05 2001 Theppitak Karoonboonyanan <thep@links.nectec.or.th>
  - use manifest

* Wed Jan 03 2001 Theppitak Karoonboonyanan <thep@links.nectec.or.th>
  - thailatex.spec : use variables for sources, path names; use BuildRoot

* Wed Aug 16 2000 Theppitak Karoonboonyanan <thep@links.nectec.or.th>
  - fix "norasi" "Bluevalues" parameter to fix Acrobat Distiller
    rejection, by Anutara

* Thu May 25 2000 Theppitak Karoonboonyanan <thep@links.nectec.or.th>
  - rearrange package and create Makefiles
  - encoding changed from TIS to LTH, according to TeX convention
  - add "norasi" bold and bold-italic font; correct TeXTIS.enc
  - make "norasi" be Thai roman font, "dbttx" Thai sans serif
  - correct some Thai translations
  - release version 0.2

* Mon Jun 21 1999 Surapant Meknavin <surapan@nectec.or.th>
  - create the original Thai LaTeX extension based on babel package
  - two fonts are available : dbtt (n,bx,i,bi) and nf3x (n,i)
  - release version 0.1

